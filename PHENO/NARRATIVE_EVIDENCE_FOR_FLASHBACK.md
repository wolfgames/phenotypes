{# PHENOTYPE: NARRATIVE_EVIDENCE_FOR_FLASHBACK #}

// Phenotype: NARRATIVE_EVIDENCE_FOR_FLASHBACK
// Primary Goal: To create a structured three-passage sequence for revealing evidence. 
// This sequence includes an initial narrative announcement, an action-only passage for the reveal mechanics, 
// and a follow-up narrative passage for commentary and progression.

PROCEDURE GenerateFlashbackEvidenceSequence(stepIDPrefix, evidenceID, revealContext, evidenceContext, followUpText, nextPassageID)
    // --- Input Parameters ---
    // stepIDPrefix: (String) Base prefix for generating unique passage UIDs.
    // evidenceID: (String) The ID of the evidence item to be revealed (e.g., "diary_page_001").
    // revealContext: (String) Narrative text for the initial discovery passage (e.g., "You find a crumpled note...").
    // evidenceContext: (String) Descriptive text for the evidence item itself, used during the REVEAL action (e.g., "A handwritten note detailing a secret meeting.").
    // followUpText: (String) Narrative text for the follow-up commentary passage (e.g., "This note changes everything...").
    // nextPassageID: (String) The UID of the passage to transition to after the follow-up commentary (e.g., "INVESTIGATION_HUB_2").

    // --- Pseudocode for Runner ---
    // 1. Define Unique Identifiers (UIDs) for the three passages:
    DEFINE initialRevealUID = stepIDPrefix + "_reveal_" + evidenceID
    DEFINE actionRevealUID = stepIDPrefix + "_action_" + evidenceID
    DEFINE followUpCommentaryUID = stepIDPrefix + "_followup_" + evidenceID

    // 2. Define a base tag for all passages generated by this phenotype:
    DEFINE phenotypeTag = "NARRATIVE_EVIDENCE_FOR_FLASHBACK"

    // 3. Construct Passage 1: Initial Narrative Discovery
    //    Purpose: Inform the player of the discovery and provide an explicit action to examine.
    //    SLPN Structure: PSG -> BOT (with revealContext) -> BRN -> BOP (links to actionRevealUID)
    
    CREATE SLPN_Passage1:
        SET UID = initialRevealUID
        SET Name = "Discovery: " + evidenceID
        SET Tags = phenotypeTag + "|DISCOVERY"
        
        ADD BOT_Message:
            SET Line = revealContext
        
        ADD BRANCH_Point:
            SET Description = "What will you do?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Examine the " + evidenceID
                SET Description = "Take a closer look at what you've found."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = actionRevealUID
    
    // 4. Construct Passage 2: Action-Only Evidence Reveal
    //    Purpose: Handle the mechanics of revealing evidence and setting up the first-view trigger.
    //    This passage contains NO BOT messages or direct narrative from the game.
    //    SLPN Structure: PSG -> ACT (REVEAL evidence) -> ACT (MOVE to evidence view) -> TRG (FIRST-VIEW -> MOVE to followUpCommentaryUID)

    CREATE SLPN_Passage2:
        SET UID = actionRevealUID
        SET Name = "Revealing: " + evidenceID
        SET Tags = phenotypeTag + "|ACTION_REVEAL"
        // IMPORTANT: No BOT command in this passage.
        
        ADD ACTION_Command_Reveal:
            SET Type = "REVEAL"
            SET EvidenceTarget = evidenceID
            SET EvidenceText = evidenceContext // Text to associate with the evidence item itself
        
        ADD ACTION_Command_MoveToEvidence:
            SET Type = "MOVE"
            ADD MOVE_Target:
                SET Type = "evidence" // Moves player focus to the evidence viewer/tab
                SET TargetUID = evidenceID
        
        ADD TRIGGER_Command_FirstView:
            SET TriggerType = "FIRST-VIEW"
            SET TriggerTarget = evidenceID // The evidence ID to monitor for first view
            ADD ACTION_Command_OnTrigger:
                SET Type = "MOVE"
                ADD MOVE_Target:
                    SET Type = "passage"
                    SET TargetUID = followUpCommentaryUID

    // 5. Construct Passage 3: Follow-up Commentary
    //    Purpose: Provide narrative insight after the player has viewed the evidence and guide them to the next step.
    //    SLPN Structure: PSG -> BOT (with followUpText) -> BRN -> BOP (links to nextPassageID)

    CREATE SLPN_Passage3:
        SET UID = followUpCommentaryUID
        SET Name = "Insight: " + evidenceID
        SET Tags = phenotypeTag + "|FOLLOWUP"
        
        ADD BOT_Message:
            SET Line = followUpText
        
        ADD BRANCH_Point:
            SET Description = "What next?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Continue Investigation"
                SET Description = "Process this new information and decide your next move."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = nextPassageID
                        
    // 6. Assemble the final SLPN output string, concatenating the SLPN for Passage1, Passage2, and Passage3, separated by double newlines.
    RETURN SLPN_Passage1 + "\n\n" + SLPN_Passage2 + "\n\n" + SLPN_Passage3
END_PROCEDURE


// --- Example Usage (Illustrative) ---
/*
CALL GenerateFlashbackEvidenceSequence(
    stepIDPrefix = "CASE01_EVIDENCE_SEQ_A",
    evidenceID = "diary_entry_003",
    revealContext = "Rummaging through the desk, you find a small, leather-bound diary. A specific page is dog-eared.",
    evidenceContext = "Diary Entry: \"He came to see me again last night. I told him to leave, but he wouldn't listen. I fear what he might do.\"",
    followUpText = "The fear in these words is palpable. This 'he' must be our prime suspect. We need to find out who this refers to.",
    nextPassageID = "INTERROGATE_SUSPECT_JOHN_DOE"
)
*/

// --- Sample SLPN Output (Based on the example usage) ---
/*
PSG:uid=CASE01_EVIDENCE_SEQ_A_reveal_diary_entry_003;nam="Discovery: diary_entry_003";tag=NARRATIVE_EVIDENCE_FOR_FLASHBACK|DISCOVERY;BOT:lin="Rummaging through the desk, you find a small, leather-bound diary. A specific page is dog-eared.";brn=BRN:bds="What will you do?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Examine the diary_entry_003";ods="Take a closer look at what you've found.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=CASE01_EVIDENCE_SEQ_A_action_diary_entry_003;

PSG:uid=CASE01_EVIDENCE_SEQ_A_action_diary_entry_003;nam="Revealing: diary_entry_003";tag=NARRATIVE_EVIDENCE_FOR_FLASHBACK|ACTION_REVEAL;ACT:aty=REVEAL;aet=diary_entry_003;axt="Diary Entry: \"He came to see me again last night. I told him to leave, but he wouldn't listen. I fear what he might do.\"";ACT:aty=MOVE;amt=AMT:typ=evidence;tgt=diary_entry_003;TRG:typ=FIRST-VIEW;tgt=diary_entry_003;act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=CASE01_EVIDENCE_SEQ_A_followup_diary_entry_003;

PSG:uid=CASE01_EVIDENCE_SEQ_A_followup_diary_entry_003;nam="Insight: diary_entry_003";tag=NARRATIVE_EVIDENCE_FOR_FLASHBACK|FOLLOWUP;BOT:lin="The fear in these words is palpable. This 'he' must be our prime suspect. We need to find out who this refers to.";brn=BRN:bds="What next?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Continue Investigation";ods="Process this new information and decide your next move.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=INTERROGATE_SUSPECT_JOHN_DOE;
*/

{# END_PHENOTYPE: NARRATIVE_EVIDENCE_FOR_FLASHBACK #}
