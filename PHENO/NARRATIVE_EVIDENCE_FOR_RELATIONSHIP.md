{# PHENOTYPE: NARRATIVE_EVIDENCE_FOR_RELATIONSHIP #}

// Phenotype: NARRATIVE_EVIDENCE_FOR_RELATIONSHIP
// Primary Goal: To create a structured three-passage sequence for revealing evidence that sheds light on a relationship between characters.
// This sequence includes an initial narrative prompt, an action-only passage for the evidence reveal mechanics, 
// and a follow-up narrative passage for commentary and progression.
// Follows the pattern of NARRATIVE_EVIDENCE_FOR_FLASHBACK, MOTIVE, and REFLECTION.

PROCEDURE GenerateRelationshipEvidenceSequence(stepIDPrefix, relationshipID, sourceEvidenceID, initialNarrativeText, evidenceContextText, followUpNarrativeText, nextPassageID)
    // --- Input Parameters ---
    // stepIDPrefix: (String) Base prefix for generating unique passage UIDs.
    // relationshipID: (String) The Relationship_Definition this evidence pertains to (for context/naming, e.g., "SECRET_ALLIANCE_A_B").
    // sourceEvidenceID: (String) The unique ID (aet) of the pre-defined evidence item containing the relationship information (e.g., "coded_letter_002").
    // initialNarrativeText: (String) Narrative text for the initial passage, hinting at the relationship discovery (e.g., "A re-examination of the crime scene photos reveals a detail you missed before...").
    // evidenceContextText: (String) Descriptive text for the sourceEvidenceID item itself, used during the REVEAL action (e.g., "A photograph showing suspects A and B in a clandestine meeting days before the incident.").
    // followUpNarrativeText: (String) Narrative text for the follow-up commentary passage (e.g., "This proves A and B knew each other, possibly far better than they let on. What was the nature of their connection?").
    // nextPassageID: (String) The UID of the passage to transition to after the follow-up commentary (e.g., "INVESTIGATE_SUSPECT_A_BACKGROUND").

    // --- Pseudocode for Runner ---
    // 1. Define Unique Identifiers (UIDs) for the three passages:
    DEFINE initialRelationshipUID = stepIDPrefix + "_initialRelationship_" + sourceEvidenceID
    DEFINE actionRelationshipUID = stepIDPrefix + "_actionRelationship_" + sourceEvidenceID
    DEFINE followUpRelationshipUID = stepIDPrefix + "_followupRelationship_" + sourceEvidenceID

    // 2. Define a base tag for all passages generated by this phenotype:
    DEFINE phenotypeTag = "NARRATIVE_EVIDENCE_FOR_RELATIONSHIP"

    // 3. Construct Passage 1: Initial Narrative Hint for Relationship
    //    Purpose: Alert the player to a potential relationship link and provide an action to examine the revealing evidence.
    //    SLPN Structure: PSG -> BOT (with initialNarrativeText) -> BRN -> BOP (links to actionRelationshipUID)
    
    CREATE SLPN_Passage1:
        SET UID = initialRelationshipUID
        SET Name = "Relationship Clue: " + relationshipID + " (" + sourceEvidenceID + ")"
        SET Tags = phenotypeTag + "|RELATIONSHIP_HINT"
        
        ADD BOT_Message:
            SET Line = initialNarrativeText
        
        ADD BRANCH_Point:
            SET Description = "Explore this connection?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Examine evidence: " + sourceEvidenceID
                SET Description = "Investigate this piece of evidence."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = actionRelationshipUID
    
    // 4. Construct Passage 2: Action-Only Relationship Evidence Reveal
    //    Purpose: Handle the mechanics of revealing the relationship evidence and setting up the first-view trigger.
    //    This passage contains NO BOT messages or direct narrative from the game.
    //    SLPN Structure: PSG -> ACT (REVEAL sourceEvidenceID with evidenceContextText) -> ACT (MOVE to evidence view) -> TRG (FIRST-VIEW -> MOVE to followUpRelationshipUID)

    CREATE SLPN_Passage2:
        SET UID = actionRelationshipUID
        SET Name = "Revealing Relationship Evidence: " + sourceEvidenceID
        SET Tags = phenotypeTag + "|RELATIONSHIP_ACTION_REVEAL"
        // IMPORTANT: No BOT command in this passage.
        
        ADD ACTION_Command_Reveal:
            SET Type = "REVEAL"
            SET EvidenceTarget = sourceEvidenceID
            SET EvidenceText = evidenceContextText // Text to associate with the relationship evidence item itself
        
        ADD ACTION_Command_MoveToEvidence:
            SET Type = "MOVE"
            ADD MOVE_Target:
                SET Type = "evidence" // Moves player focus to the evidence viewer/tab
                SET TargetUID = sourceEvidenceID
        
        ADD TRIGGER_Command_FirstView:
            SET TriggerType = "FIRST-VIEW"
            SET TriggerTarget = sourceEvidenceID // The evidence ID to monitor for first view
            ADD ACTION_Command_OnTrigger:
                SET Type = "MOVE"
                ADD MOVE_Target:
                    SET Type = "passage"
                    SET TargetUID = followUpRelationshipUID

    // 5. Construct Passage 3: Follow-up Commentary on Relationship
    //    Purpose: Provide narrative insight about the discovered relationship after the player has viewed the evidence.
    //    SLPN Structure: PSG -> BOT (with followUpNarrativeText) -> BRN -> BOP (links to nextPassageID)

    CREATE SLPN_Passage3:
        SET UID = followUpRelationshipUID
        SET Name = "Insight on Relationship: " + relationshipID
        SET Tags = phenotypeTag + "|RELATIONSHIP_FOLLOWUP"
        
        ADD BOT_Message:
            SET Line = followUpNarrativeText
        
        ADD BRANCH_Point:
            SET Description = "What does this mean?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Continue with this new understanding"
                SET Description = "Factor this relationship into your investigation."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = nextPassageID
                        
    // 6. Assemble the final SLPN output string, concatenating the SLPN for Passage1, Passage2, and Passage3, separated by double newlines.
    RETURN SLPN_Passage1 + "\n\n" + SLPN_Passage2 + "\n\n" + SLPN_Passage3
END_PROCEDURE


// --- Example Usage (Illustrative) ---
/*
CALL GenerateRelationshipEvidenceSequence(
    stepIDPrefix = "REL_EVD_SEQ_D",
    relationshipID = "OLD_RIVALRY_X_Y",
    sourceEvidenceID = "torn_photo_half_001",
    initialNarrativeText = "Amongst the discarded items, you find a torn photograph. It seems to depict two people...",
    evidenceContextText = "A faded, torn photograph. One half shows a young X, the other half, when pieced together with a corresponding evidence item, would show Y. They appear to be in a heated argument.",
    followUpNarrativeText = "This photo suggests a past conflict between X and Y. Could an old grudge be relevant to this case?",
    nextPassageID = "SEARCH_FOR_OTHER_PHOTO_HALF"
)
*/

// --- Sample SLPN Output (Based on the example usage) ---
/*
PSG:uid=REL_EVD_SEQ_D_initialRelationship_torn_photo_half_001;nam="Relationship Clue: OLD_RIVALRY_X_Y (torn_photo_half_001)";tag=NARRATIVE_EVIDENCE_FOR_RELATIONSHIP|RELATIONSHIP_HINT;BOT:lin="Amongst the discarded items, you find a torn photograph. It seems to depict two people...";brn=BRN:bds="Explore this connection?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Examine evidence: torn_photo_half_001";ods="Investigate this piece of evidence.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=REL_EVD_SEQ_D_actionRelationship_torn_photo_half_001;

PSG:uid=REL_EVD_SEQ_D_actionRelationship_torn_photo_half_001;nam="Revealing Relationship Evidence: torn_photo_half_001";tag=NARRATIVE_EVIDENCE_FOR_RELATIONSHIP|RELATIONSHIP_ACTION_REVEAL;ACT:aty=REVEAL;aet=torn_photo_half_001;axt="A faded, torn photograph. One half shows a young X, the other half, when pieced together with a corresponding evidence item, would show Y. They appear to be in a heated argument.";ACT:aty=MOVE;amt=AMT:typ=evidence;tgt=torn_photo_half_001;TRG:typ=FIRST-VIEW;tgt=torn_photo_half_001;act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=REL_EVD_SEQ_D_followupRelationship_torn_photo_half_001;

PSG:uid=REL_EVD_SEQ_D_followupRelationship_torn_photo_half_001;nam="Insight on Relationship: OLD_RIVALRY_X_Y";tag=NARRATIVE_EVIDENCE_FOR_RELATIONSHIP|RELATIONSHIP_FOLLOWUP;BOT:lin="This photo suggests a past conflict between X and Y. Could an old grudge be relevant to this case?";brn=BRN:bds="What does this mean?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Continue with this new understanding";ods="Factor this relationship into your investigation.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=SEARCH_FOR_OTHER_PHOTO_HALF;
*/

{# END_PHENOTYPE: NARRATIVE_EVIDENCE_FOR_RELATIONSHIP #}
