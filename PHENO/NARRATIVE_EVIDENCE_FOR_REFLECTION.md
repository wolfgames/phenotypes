{# PHENOTYPE: NARRATIVE_EVIDENCE_FOR_REFLECTION #}

// Phenotype: NARRATIVE_EVIDENCE_FOR_REFLECTION
// Primary Goal: To create a structured three-passage sequence for revealing "observation" evidence related to a character's internal state or reaction.
// This sequence includes an initial narrative cue, an action-only passage for the reveal mechanics, 
// and a follow-up narrative passage for commentary and progression.
// Patterned after NARRATIVE_EVIDENCE_FOR_FLASHBACK and NARRATIVE_EVIDENCE_FOR_MOTIVE.

PROCEDURE GenerateReflectionEvidenceSequence(stepIDPrefix, characterID, observationEvidenceID, initialNarrativeText, evidenceContextText, followUpNarrativeText, nextPassageID)
    // --- Input Parameters ---
    // stepIDPrefix: (String) Base prefix for generating unique passage UIDs.
    // characterID: (String) The Character_Definition this observation pertains to (for context/naming, e.g., "DETECTIVE_MILLER").
    // observationEvidenceID: (String) The unique ID (aet) of the pre-defined "observation" evidence item (e.g., "obs_miller_unease_01").
    // initialNarrativeText: (String) Narrative text for the initial passage, prompting the reflection (e.g., "Recalling Miller's hesitation, something feels off...").
    // evidenceContextText: (String) Descriptive text for the observationEvidenceID item itself, used during the REVEAL action (e.g., "Observation: Detective Miller avoided eye contact and seemed unusually tense when discussing the alibi.").
    // followUpNarrativeText: (String) Narrative text for the follow-up commentary passage (e.g., "This observation suggests Miller might be hiding something or under considerable stress.").
    // nextPassageID: (String) The UID of the passage to transition to after the follow-up commentary (e.g., "CROSS_REFERENCE_MILLER_STATEMENT").

    // --- Pseudocode for Runner ---
    // 1. Define Unique Identifiers (UIDs) for the three passages:
    DEFINE initialReflectionUID = stepIDPrefix + "_initialReflection_" + observationEvidenceID
    DEFINE actionReflectionUID = stepIDPrefix + "_actionReflection_" + observationEvidenceID
    DEFINE followUpReflectionUID = stepIDPrefix + "_followupReflection_" + observationEvidenceID

    // 2. Define a base tag for all passages generated by this phenotype:
    DEFINE phenotypeTag = "NARRATIVE_EVIDENCE_FOR_REFLECTION"

    // 3. Construct Passage 1: Initial Narrative Cue for Reflection
    //    Purpose: Inform the player about a notable observation or reflection point and provide an action to examine the related "evidence".
    //    SLPN Structure: PSG -> BOT (with initialNarrativeText) -> BRN -> BOP (links to actionReflectionUID)
    
    CREATE SLPN_Passage1:
        SET UID = initialReflectionUID
        SET Name = "Reflection on " + characterID + ": " + observationEvidenceID
        SET Tags = phenotypeTag + "|REFLECTION_CUE"
        
        ADD BOT_Message:
            SET Line = initialNarrativeText
        
        ADD BRANCH_Point:
            SET Description = "Consider this observation?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Examine observation: " + observationEvidenceID
                SET Description = "Focus on this detail."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = actionReflectionUID
    
    // 4. Construct Passage 2: Action-Only Observation Evidence Reveal
    //    Purpose: Handle the mechanics of revealing the observation evidence and setting up the first-view trigger.
    //    This passage contains NO BOT messages or direct narrative from the game.
    //    SLPN Structure: PSG -> ACT (REVEAL observationEvidenceID with evidenceContextText) -> ACT (MOVE to evidence view) -> TRG (FIRST-VIEW -> MOVE to followUpReflectionUID)

    CREATE SLPN_Passage2:
        SET UID = actionReflectionUID
        SET Name = "Revealing Observation: " + observationEvidenceID
        SET Tags = phenotypeTag + "|REFLECTION_ACTION_REVEAL"
        // IMPORTANT: No BOT command in this passage.
        
        ADD ACTION_Command_Reveal:
            SET Type = "REVEAL"
            SET EvidenceTarget = observationEvidenceID
            SET EvidenceText = evidenceContextText // Text to associate with the observation evidence item itself
        
        ADD ACTION_Command_MoveToEvidence:
            SET Type = "MOVE"
            ADD MOVE_Target:
                SET Type = "evidence" // Moves player focus to the evidence viewer/tab
                SET TargetUID = observationEvidenceID
        
        ADD TRIGGER_Command_FirstView:
            SET TriggerType = "FIRST-VIEW"
            SET TriggerTarget = observationEvidenceID // The evidence ID to monitor for first view
            ADD ACTION_Command_OnTrigger:
                SET Type = "MOVE"
                ADD MOVE_Target:
                    SET Type = "passage"
                    SET TargetUID = followUpReflectionUID

    // 5. Construct Passage 3: Follow-up Commentary on Reflection
    //    Purpose: Provide narrative insight about the character's observed behavior/state after the player has viewed the evidence.
    //    SLPN Structure: PSG -> BOT (with followUpNarrativeText) -> BRN -> BOP (links to nextPassageID)

    CREATE SLPN_Passage3:
        SET UID = followUpReflectionUID
        SET Name = "Insight from Reflection: " + characterID
        SET Tags = phenotypeTag + "|REFLECTION_FOLLOWUP"
        
        ADD BOT_Message:
            SET Line = followUpNarrativeText
        
        ADD BRANCH_Point:
            SET Description = "What to make of this?"
            SET Replayable = "once"
            SET Presentation = "option-list"
            SET InteractionType = "blocking"
            
            ADD BRANCH_Option:
                SET Name = "Continue with this insight"
                SET Description = "Proceed, keeping this observation in mind."
                ADD ACTION_Command:
                    SET Type = "MOVE"
                    ADD MOVE_Target:
                        SET Type = "passage"
                        SET TargetUID = nextPassageID
                        
    // 6. Assemble the final SLPN output string, concatenating the SLPN for Passage1, Passage2, and Passage3, separated by double newlines.
    RETURN SLPN_Passage1 + "\n\n" + SLPN_Passage2 + "\n\n" + SLPN_Passage3
END_PROCEDURE


// --- Example Usage (Illustrative) ---
/*
CALL GenerateReflectionEvidenceSequence(
    stepIDPrefix = "CH_REFLECT_SEQ_C",
    characterID = "WITNESS_SARAH",
    observationEvidenceID = "obs_sarah_trembling_hands_001",
    initialNarrativeText = "You noticed Sarah's hands were trembling when she mentioned the alibi. It might be worth noting.",
    evidenceContextText = "Observation: Witness Sarah's hands trembled noticeably when she recounted her whereabouts on the night of the incident. She clasped them tightly to try and hide it.",
    followUpNarrativeText = "Her nervousness was undeniable. Is she merely shaken by the events, or is there more to her anxiety?",
    nextPassageID = "REVIEW_SARAH_TESTIMONY_AGAIN"
)
*/

// --- Sample SLPN Output (Based on the example usage) ---
/*
PSG:uid=CH_REFLECT_SEQ_C_initialReflection_obs_sarah_trembling_hands_001;nam="Reflection on WITNESS_SARAH: obs_sarah_trembling_hands_001";tag=NARRATIVE_EVIDENCE_FOR_REFLECTION|REFLECTION_CUE;BOT:lin="You noticed Sarah's hands were trembling when she mentioned the alibi. It might be worth noting.";brn=BRN:bds="Consider this observation?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Examine observation: obs_sarah_trembling_hands_001";ods="Focus on this detail.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=CH_REFLECT_SEQ_C_actionReflection_obs_sarah_trembling_hands_001;

PSG:uid=CH_REFLECT_SEQ_C_actionReflection_obs_sarah_trembling_hands_001;nam="Revealing Observation: obs_sarah_trembling_hands_001";tag=NARRATIVE_EVIDENCE_FOR_REFLECTION|REFLECTION_ACTION_REVEAL;ACT:aty=REVEAL;aet=obs_sarah_trembling_hands_001;axt="Observation: Witness Sarah's hands trembled noticeably when she recounted her whereabouts on the night of the incident. She clasped them tightly to try and hide it.";ACT:aty=MOVE;amt=AMT:typ=evidence;tgt=obs_sarah_trembling_hands_001;TRG:typ=FIRST-VIEW;tgt=obs_sarah_trembling_hands_001;act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=CH_REFLECT_SEQ_C_followupReflection_obs_sarah_trembling_hands_001;

PSG:uid=CH_REFLECT_SEQ_C_followupReflection_obs_sarah_trembling_hands_001;nam="Insight from Reflection: WITNESS_SARAH";tag=NARRATIVE_EVIDENCE_FOR_REFLECTION|REFLECTION_FOLLOWUP;BOT:lin="Her nervousness was undeniable. Is she merely shaken by the events, or is there more to her anxiety?";brn=BRN:bds="What to make of this?";brp=once;bpr=option-list;bit=blocking;ops=BOP:onm="Continue with this insight";ods="Proceed, keeping this observation in mind.";act=ACT:aty=MOVE;amt=AMT:typ=passage;tgt=REVIEW_SARAH_TESTIMONY_AGAIN;
*/

{# END_PHENOTYPE: NARRATIVE_EVIDENCE_FOR_REFLECTION #}
